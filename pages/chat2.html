<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>XupChat â€“ Chat</title>
  <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet" />
  <script>
    tailwind.config = {
      darkMode: 'media',
    };
  </script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Custom styles for chat bubbles */
    .message-container {
      display: flex;
      margin-bottom: 1rem;
    }
    .message-container.sent {
      justify-content: flex-end;
    }
    .message-container.received {
      justify-content: flex-start;
    }
    .message-bubble {
      max-width: 70%;
      padding: 0.75rem 1rem;
      border-radius: 1rem;
      position: relative;
      word-wrap: break-word;
    }
    .sent .message-bubble {
      background-color: #6366f1;
      color: white;
      border-bottom-right-radius: 0.25rem;
    }
    .received .message-bubble {
      background-color: #f3f4f6;
      color: #111827;
      border-bottom-left-radius: 0.25rem;
    }
    @media (prefers-color-scheme: dark) {
      .received .message-bubble {
        background-color: #1f2937;
        color: #f9fafb;
      }
    }
    .message-time {
      font-size: 0.75rem;
      opacity: 0.8;
      margin-top: 0.25rem;
      text-align: right;
    }
    .message-status {
      position: absolute;
      right: -1.5rem;
      bottom: 0;
    }
    /* Smooth scrolling */
    #chatArea {
      scroll-behavior: smooth;
    }
    /* Typing indicator animation */
    .typing-dots {
      display: inline-flex;
      align-items: center;
    }
    .typing-dots span {
      height: 8px;
      width: 8px;
      margin: 0 2px;
      background-color: #6b7280;
      border-radius: 50%;
      display: inline-block;
      animation: typing 1s infinite ease-in-out;
    }
    .typing-dots span:nth-child(2) {
      animation-delay: 0.2s;
    }
    .typing-dots span:nth-child(3) {
      animation-delay: 0.4s;
    }
    @keyframes typing {
      0%, 100% {
        transform: translateY(0);
      }
      50% {
        transform: translateY(-5px);
      }
    }
  </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 font-sans min-h-screen">
  <div class="flex flex-col h-screen">
    <!-- Top Navbar -->
    <nav class="bg-indigo-600 text-white px-4 py-3 flex items-center shadow-md">
      <button id="backBtn" class="text-2xl mr-2"><i class='bx bx-chevron-left'></i></button>
      <div class="flex-1">
        <h1 id="chatUserName" class="text-lg font-bold truncate">Loading...</h1>
        <div id="typingIndicator" class="text-xs hidden">
          <span class="typing-dots">
            <span></span>
            <span></span>
            <span></span>
          </span>
          <span id="typingText">typing</span>
        </div>
      </div>
      <button id="logoutBtn" class="text-xl p-2 rounded-full hover:bg-indigo-700 transition">
        <i class='bx bx-log-out'></i>
      </button>
    </nav>
    <!-- Chat Area -->
    <div id="chatArea" class="flex-1 p-4 overflow-y-auto bg-gray-50 dark:bg-gray-800">
      <div id="messagesContainer" class="space-y-2">
        <!-- Messages will be dynamically injected here -->
      </div>
    </div>
    <!-- Message Input -->
    <div class="p-3 bg-white dark:bg-gray-700 border-t border-gray-200 dark:border-gray-600 flex items-center">
      <input type="text" id="messageInput" 
        class="flex-1 p-2 border rounded-full focus:outline-none focus:ring-2 focus:ring-indigo-300 dark:bg-gray-800 dark:border-gray-600 dark:text-gray-100" 
        placeholder="Type a message..." 
        autocomplete="off" />
      <button id="sendBtn" class="ml-2 bg-indigo-600 text-white p-2 rounded-full hover:bg-indigo-700 transition">
        <i class='bx bx-send text-xl'></i>
      </button>
    </div>
  </div>

  <!-- SweetAlert for confirmation dialogs -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <!-- Firebase SDK & Chat Script -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-auth.js";
    import { 
      getFirestore, 
      collection, 
      addDoc, 
      query, 
      where, 
      onSnapshot, 
      serverTimestamp, 
      updateDoc, 
      doc, 
      setDoc,
      orderBy 
    } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCsa2c82g1OHNU2HcxCyQLr5RSM7DEDQXM",
      authDomain: "deepvoid-6baf3.firebaseapp.com",
      projectId: "deepvoid-6baf3",
      storageBucket: "deepvoid-6baf3.appspot.com",
      messagingSenderId: "648550508783",
      appId: "1:648550508783:web:6220982bf050d8e74b531a"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const chatWithUID = localStorage.getItem("chatWithUID");
    const chatWithName = localStorage.getItem("chatWithName");
    let currentUserID = null;
    const roomId = [chatWithUID, auth.currentUser?.uid].sort().join("_");
    const chatUserName = document.getElementById("chatUserName");
    const messagesContainer = document.getElementById("messagesContainer");
    const messageInput = document.getElementById("messageInput");
    const sendBtn = document.getElementById("sendBtn");
    const typingIndicator = document.getElementById("typingIndicator");

    function formatTimestamp(timestamp) {
      if (!timestamp) return '';
      const date = timestamp.toDate();
      return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    document.getElementById("backBtn").addEventListener("click", () => {
      window.location.href = "../pages/chat-list.html";
    });

    document.getElementById("logoutBtn").addEventListener("click", async () => {
      const result = await Swal.fire({
        title: 'Log Out?',
        text: 'Are you sure you want to log out?',
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#6366f1',
        cancelButtonColor: '#6b7280',
        confirmButtonText: 'Yes, log out'
      });
      if (result.isConfirmed) {
        try {
          await signOut(auth);
          window.location.href = "login.html";
        } catch (error) {
          Swal.fire('Error', 'Failed to log out. Please try again.', 'error');
        }
      }
    });

    onAuthStateChanged(auth, (user) => {
      if (user) {
        currentUserID = user.uid;
        chatUserName.innerText = chatWithName || "Chat";
        loadMessages();
      } else {
        window.location.href = "login.html";
      }
    });

    function loadMessages() {
      const messagesRef = collection(db, "chats");
      const chatQuery = query(
        messagesRef, 
        where("roomId", "==", [currentUserID, chatWithUID].sort().join("_")),
        orderBy("timestamp", "asc")
      );
      onSnapshot(chatQuery, (snapshot) => {
        messagesContainer.innerHTML = "";
        snapshot.forEach((docSnap) => {
          const msg = docSnap.data();
          const isSent = msg.sender === currentUserID;
          const messageDiv = document.createElement("div");
          messageDiv.className = `message-container ${isSent ? 'sent' : 'received'}`;
          const bubbleDiv = document.createElement("div");
          bubbleDiv.className = "message-bubble";
          if (msg.replyTo) {
            const replyDiv = document.createElement("div");
            replyDiv.className = `p-2 mb-1 text-xs rounded ${isSent ? 'bg-indigo-500 bg-opacity-30' : 'bg-gray-200 dark:bg-gray-700 dark:text-gray-100'}`;
            replyDiv.innerHTML = `<strong>Reply:</strong> ${msg.replyText || "No content"}`;
            bubbleDiv.appendChild(replyDiv);
          }
          const textDiv = document.createElement("div");
          textDiv.textContent = msg.text;
          bubbleDiv.appendChild(textDiv);
          const timeDiv = document.createElement("div");
          timeDiv.className = "message-time";
          timeDiv.textContent = formatTimestamp(msg.timestamp);
          bubbleDiv.appendChild(timeDiv);
          if (isSent) {
            const statusDiv = document.createElement("div");
            statusDiv.className = "message-status";
            statusDiv.innerHTML = '<i class="bx bx-check text-xs"></i>';
            bubbleDiv.appendChild(statusDiv);
          }
          messageDiv.appendChild(bubbleDiv);
          messagesContainer.appendChild(messageDiv);
        });
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      });

      onSnapshot(doc(db, "typing", roomId), (docSnap) => {
        const typingData = docSnap.data();
        if (typingData?.isTyping && typingData.userId !== currentUserID) {
          typingIndicator.classList.remove("hidden");
        } else {
          typingIndicator.classList.add("hidden");
        }
      });
    }

    function sendMessage() {
      const text = messageInput.value.trim();
      if (!text) return;
      const message = {
        sender: currentUserID,
        receiver: chatWithUID,
        text,
        roomId: [currentUserID, chatWithUID].sort().join("_"),
        timestamp: serverTimestamp(),
        replyTo: null,
        replyText: null
      };
      addDoc(collection(db, "chats"), message);
      messageInput.value = "";
      updateTypingStatus(false);
      setTimeout(() => {
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      }, 100);
      triggerNotification(message);
    }

    sendBtn.addEventListener("click", sendMessage);
    messageInput.addEventListener("keypress", (e) => {
      if (e.key === "Enter") {
        sendMessage();
      }
    });

    let typingTimeout;
    messageInput.addEventListener("input", () => {
      updateTypingStatus(true);
      clearTimeout(typingTimeout);
      typingTimeout = setTimeout(() => updateTypingStatus(false), 2000);
    });

    async function updateTypingStatus(isTyping) {
      await setDoc(doc(db, "typing", roomId), {
        isTyping,
        userId: currentUserID
      });
    }

    async function triggerNotification(message) {
      const notificationData = {
        userId: chatWithUID,
        senderName: auth.currentUser.displayName || "Anonymous",
        senderAvatar: auth.currentUser.photoURL || "https://www.gravatar.com/avatar?d=mp",
        message: message.text,
        type: "chat_message",
        channel: "Private Chat",
        timestamp: serverTimestamp(),
        read: false
      };

      try {
        await addDoc(collection(db, "notifications"), notificationData);
        console.log("Notification triggered successfully.");
      } catch (error) {
        console.error("Error triggering notification:", error);
      }
    }

    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('../firebase-messaging-sw.js')
        .then((registration) => {
          console.log('Service Worker registered:', registration);
        })
        .catch((error) => {
          console.error('Service Worker registration failed:', error);
        });
    }
  </script>
</body>
</html>
